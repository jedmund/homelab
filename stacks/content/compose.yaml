services:
  # Immich
  immich-server:
    container_name: immich_server
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}
    volumes:
      - photos:/usr/src/app/upload
      - /etc/localtime:/etc/localtime:ro
    env_file:
      - .env
    ports:
      - '2283:2283'
    depends_on:
      - immich-redis
      - immich-database
    restart: always
    healthcheck:
      disable: false

  immich-machine-learning:
    container_name: immich_machine_learning
    image: ghcr.io/immich-app/immich-machine-learning:${IMMICH_VERSION:-release}
    volumes:
      - model-cache:/cache
    env_file:
      - .env
    restart: always
    healthcheck:
      disable: false

  immich-redis:
    container_name: immich_redis
    image: docker.io/valkey/valkey:8-bookworm@sha256:fec42f399876eb6faf9e008570597741c87ff7662a54185593e74b09ce83d177
    healthcheck:
      test: redis-cli ping || exit 1
    restart: always

  immich-database:
    container_name: immich_postgres
    image: ghcr.io/immich-app/postgres:14-vectorchord0.4.3-pgvectors0.2.0
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_DB: ${DB_DATABASE_NAME}
      POSTGRES_INITDB_ARGS: '--data-checksums'
    volumes:
      - ${DB_DATA_LOCATION}:/var/lib/postgresql/data
    restart: always

  # Paperless-ngx
  paperless-broker:
    container_name: paperless_redis
    image: docker.io/library/redis:8
    restart: unless-stopped
    volumes:
      - paperless-redisdata:/data

  paperless-db:
    container_name: paperless_postgres
    image: docker.io/library/postgres:17
    restart: unless-stopped
    volumes:
      - paperless-pgdata:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: paperless
      POSTGRES_USER: paperless
      POSTGRES_PASSWORD: ${PAPERLESS_DB_PASSWORD:-paperless}  # Consider setting this in .env

  paperless-webserver:
    container_name: paperless_web
    image: ghcr.io/paperless-ngx/paperless-ngx:latest
    restart: unless-stopped
    depends_on:
      - paperless-db
      - paperless-broker
    ports:
      - "8787:8000"
    volumes:
      - paperless-data:/usr/src/paperless/data
      - paperless-media:/usr/src/paperless/media
      - paperless-export:/usr/src/paperless/export
      - paperless-consume:/usr/src/paperless/consume
    env_file: 
      - paperless.env  # Renamed to avoid conflict with Immich's .env
    environment:
      PAPERLESS_REDIS: redis://paperless-broker:6379
      PAPERLESS_DBHOST: paperless-db

  # Optional: Paperless backup service
  paperless-backup:
    container_name: paperless_backup
    image: docker.io/library/postgres:17
    restart: unless-stopped
    depends_on:
      - paperless-db
    environment:
      - PGHOST=paperless-db
      - PGUSER=paperless
      - PGPASSWORD=${PAPERLESS_DB_PASSWORD:-paperless}
      - TZ=${TZ:-America/Los_Angeles}
    volumes:
      - ./backups/paperless:/backup
      - paperless-data:/usr/src/paperless/data:ro
      - paperless-media:/usr/src/paperless/media:ro
    entrypoint: |
      sh -c 'while true; do
        echo "Backing up Paperless database..."
        pg_dump -U paperless paperless > /backup/paperless_db_$$(date +%Y%m%d_%H%M%S).sql
        # Also create a document export
        echo "Document export should be done via Paperless web interface or CLI"
        # Keep only last 7 backups
        ls -t /backup/paperless_db_*.sql | tail -n +8 | xargs -r rm
        echo "Backup complete. Sleeping for 24 hours..."
        sleep 86400
      done'

# Replace 192.168.1.999 with the local IP address of your NAS or storage.

# Remember to enable NFS on the shared volume in Synology or otherwise.
# Also, remember to change the path to the desired directory as well.
# Synology will always start with /volume1/

volumes:
  # Immich volumes
  model-cache:
  photos:
    driver: local
    driver_opts:
      type: nfs
      # Larger read and write sizes are necessary for image and video transfers
      o: "addr=192.168.1.999,vers=4,nolock,soft,rw,rsize=65536,wsize=65536"
      device: ":/volume1/photos/immich"

  # Paperless volumes
  paperless-data:
  paperless-media:
    driver: local
    driver_opts:
      type: nfs
      o: "addr=192.168.1.999,vers=4,nolock,soft,rw"
      device: ":/volume1/documents/media"
  paperless-consume:
    driver: local
    driver_opts:
      type: nfs
      o: "addr=192.168.1.999,vers=4,nolock,soft,rw"
      device: ":/volume1/documents/consume"
  paperless-export:
    driver: local
    driver_opts:
      type: nfs
      o: "addr=192.168.1.999,vers=4,nolock,soft,rw"
      device: ":/volume1/documents/export"
  paperless-pgdata:
  paperless-redisdata:
