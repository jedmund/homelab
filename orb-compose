#!/bin/zsh
# OrbStack Compose Manager
# Save as ~/bin/orb-compose and chmod +x

# Ensure common binary paths are in PATH
export PATH="/usr/local/bin:/opt/homebrew/bin:/usr/bin:/bin:$PATH"

# Colors for output (defined early for error messages)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Find docker command
DOCKER_CMD=$(which docker || echo "/usr/local/bin/docker")
if [[ ! -x "$DOCKER_CMD" ]]; then
    echo "${RED}Error: Docker command not found!${NC}"
    echo "Please ensure Docker/OrbStack is installed and in your PATH"
    exit 1
fi

# Define compose file paths
typeset -A COMPOSE_FILES
COMPOSE_FILES=(
    automation "/Users/justin/Documents/Docker/stacks/automation/compose.yaml"
    docker "/Users/justin/Documents/Docker/dockge.yml"
    infra "/Users/justin/Documents/Docker/stacks/infrastructure/compose.yaml"
    media "/Users/justin/Documents/Docker/stacks/media/compose.yaml"
    content "/Users/justin/Documents/Docker/stacks/content/compose.yaml"
)
# Removed generation since the file doesn't exist

# Show usage
usage() {
    echo "${BLUE}OrbStack Compose Manager${NC}"
    echo ""
    echo "Usage: $(basename $0) <command> [project|all] [options]"
    echo ""
    echo "Commands:"
    echo "  ${GREEN}start${NC}     Start compose project(s)"
    echo "  ${GREEN}stop${NC}      Stop compose project(s) (preserves container data)"
    echo "  ${GREEN}down${NC}      Remove compose project(s) (WARNING: removes containers)"
    echo "  ${GREEN}restart${NC}   Restart compose project(s)"
    echo "  ${GREEN}status${NC}    Show status of all projects"
    echo "  ${GREEN}logs${NC}      Show logs for a project"
    echo "  ${GREEN}ps${NC}        Show running containers for a project"
    echo "  ${GREEN}exec${NC}      Execute command in a service"
    echo "  ${GREEN}check${NC}     Check for container updates"
    echo "  ${GREEN}update${NC}    Update and recreate containers"
    echo ""
    echo "Projects:"
    echo "  ${YELLOW}automation${NC}, ${YELLOW}docker${NC}, ${YELLOW}management${NC}, ${YELLOW}all${NC}"
    echo ""
    echo "Options:"
    echo "  ${YELLOW}--pull${NC}    Force pulling from remote (for check/update commands)"
    echo ""
    echo "Examples:"
    echo "  $(basename $0) start all"
    echo "  $(basename $0) stop automation"
    echo "  $(basename $0) logs docker -f"
    echo "  $(basename $0) exec management web bash"
    echo "  $(basename $0) check all              # Check using local images"
    echo "  $(basename $0) check all --pull       # Check remote registries"
    echo "  $(basename $0) update automation      # Apply available updates"
    echo "  $(basename $0) update all --pull      # Force pull and update all"
}

# Start projects
start_projects() {
    local project=$1

    if [[ -z "$project" ]]; then
        echo "${RED}Error: Please specify a project or 'all'${NC}"
        echo "Available: ${(k)COMPOSE_FILES} all"
        return 1
    fi

    if [[ "$project" == "all" ]]; then
        echo "${GREEN}Starting all compose projects...${NC}"
        for name path in ${(kv)COMPOSE_FILES}; do
            echo "${YELLOW}→ Starting $name...${NC}"
            $DOCKER_CMD compose -f "$path" up -d
        done
    elif [[ -n "${COMPOSE_FILES[$project]}" ]]; then
        echo "${GREEN}Starting $project...${NC}"
        $DOCKER_CMD compose -f "${COMPOSE_FILES[$project]}" up -d
    else
        echo "${RED}Unknown project: $project${NC}"
        echo "Available: ${(k)COMPOSE_FILES} all"
        return 1
    fi
}

# Stop projects (preserves containers)
stop_projects() {
    local project=$1

    if [[ -z "$project" ]]; then
        echo "${RED}Error: Please specify a project or 'all'${NC}"
        echo "Available: ${(k)COMPOSE_FILES} all"
        return 1
    fi

    if [[ "$project" == "all" ]]; then
        echo "${YELLOW}Stopping all compose projects...${NC}"
        for name path in ${(kv)COMPOSE_FILES}; do
            echo "${YELLOW}→ Stopping $name...${NC}"
            $DOCKER_CMD compose -f "$path" stop
        done
    elif [[ -n "${COMPOSE_FILES[$project]}" ]]; then
        echo "${YELLOW}Stopping $project...${NC}"
        $DOCKER_CMD compose -f "${COMPOSE_FILES[$project]}" stop
    else
        echo "${RED}Unknown project: $project${NC}"
        echo "Available: ${(k)COMPOSE_FILES} all"
        return 1
    fi
}

# Remove projects (removes containers - use with caution)
down_projects() {
    local project=$1

    if [[ -z "$project" ]]; then
        echo "${RED}Error: Please specify a project or 'all'${NC}"
        echo "Available: ${(k)COMPOSE_FILES} all"
        return 1
    fi

    echo "${YELLOW}WARNING: This will remove containers!${NC}"
    echo "${YELLOW}Data in mounted volumes will be preserved, but container state will be lost.${NC}"
    echo -n "Continue? (y/N): "
    read confirm
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
        echo "Cancelled."
        return 0
    fi

    if [[ "$project" == "all" ]]; then
        echo "${YELLOW}Removing all compose projects...${NC}"
        for name path in ${(kv)COMPOSE_FILES}; do
            echo "${YELLOW}→ Removing $name...${NC}"
            $DOCKER_CMD compose -f "$path" down
        done
    elif [[ -n "${COMPOSE_FILES[$project]}" ]]; then
        echo "${YELLOW}Removing $project...${NC}"
        $DOCKER_CMD compose -f "${COMPOSE_FILES[$project]}" down
    else
        echo "${RED}Unknown project: $project${NC}"
        echo "Available: ${(k)COMPOSE_FILES} all"
        return 1
    fi
}

# Restart projects
restart_projects() {
    local project=$1

    if [[ -z "$project" ]]; then
        echo "${RED}Error: Please specify a project or 'all'${NC}"
        echo "Available: ${(k)COMPOSE_FILES} all"
        return 1
    fi

    stop_projects "$project" && start_projects "$project"
}

# Show status
show_status() {
    echo "${BLUE}Docker Compose Projects Status:${NC}"
    $DOCKER_CMD compose ls -a
    echo ""
    echo "${BLUE}All Docker Containers:${NC}"
    $DOCKER_CMD ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
    echo ""

    # Quick update check
    local updates_available=false
    echo "${BLUE}Quick Update Check:${NC}"
    for container in $($DOCKER_CMD ps --format "{{.Names}}"); do
        local image=$($DOCKER_CMD inspect -f '{{.Config.Image}}' "$container" 2>/dev/null)
        local running_id=$($DOCKER_CMD inspect -f '{{.Image}}' "$container" 2>/dev/null | cut -d: -f2 | cut -c1-12)
        local latest_id=$($DOCKER_CMD images --format "{{.ID}}" "$image" 2>/dev/null | head -1)

        if [[ -n "$running_id" ]] && [[ -n "$latest_id" ]] && [[ "$running_id" != "$latest_id" ]]; then
            echo "  ${YELLOW}⚠ $container has an update available${NC}"
            updates_available=true
        fi
    done

    if [[ "$updates_available" == false ]]; then
        echo "  ${GREEN}✓ All containers are up to date${NC}"
    else
        echo ""
        echo "Run 'oc check <project>' for details or 'oc update <project>' to apply"
    fi
}

# Show logs
show_logs() {
    local project=$1
    shift  # Remove project name to pass remaining args to docker compose

    if [[ -z "$project" ]]; then
        echo "${RED}Error: Please specify a project${NC}"
        echo "Available: ${(k)COMPOSE_FILES}"
        return 1
    fi

    if [[ -n "${COMPOSE_FILES[$project]}" ]]; then
        $DOCKER_CMD compose -f "${COMPOSE_FILES[$project]}" logs "$@"
    else
        echo "${RED}Unknown project: $project${NC}"
        echo "Available: ${(k)COMPOSE_FILES}"
        return 1
    fi
}

# Show containers for a project
show_ps() {
    local project=$1
    shift

    if [[ -z "$project" ]]; then
        echo "${RED}Error: Please specify a project${NC}"
        echo "Available: ${(k)COMPOSE_FILES}"
        return 1
    fi

    if [[ -n "${COMPOSE_FILES[$project]}" ]]; then
        $DOCKER_CMD compose -f "${COMPOSE_FILES[$project]}" ps "$@"
    else
        echo "${RED}Unknown project: $project${NC}"
        echo "Available: ${(k)COMPOSE_FILES}"
        return 1
    fi
}

# Execute command in service
exec_in_service() {
    local project=$1
    shift

    if [[ -z "$project" ]]; then
        echo "${RED}Error: Please specify a project${NC}"
        echo "Available: ${(k)COMPOSE_FILES}"
        return 1
    fi

    if [[ -n "${COMPOSE_FILES[$project]}" ]]; then
        $DOCKER_CMD compose -f "${COMPOSE_FILES[$project]}" exec "$@"
    else
        echo "${RED}Unknown project: $project${NC}"
        echo "Available: ${(k)COMPOSE_FILES}"
        return 1
    fi
}

# Check for updates
check_updates() {
    local project=$1
    local pull_flag=$2  # Optional: --pull to force checking remote

    if [[ -z "$project" ]]; then
        echo "${RED}Error: Please specify a project or 'all'${NC}"
        echo "Available: ${(k)COMPOSE_FILES} all"
        return 1
    fi

    echo "${BLUE}Checking for container updates...${NC}"
    if [[ "$pull_flag" == "--pull" ]]; then
        echo "${YELLOW}(Checking remote registries - this may take a moment)${NC}"
    else
        echo "${YELLOW}(Checking local images - use 'check --pull' to check remote)${NC}"
    fi
    echo ""

    # Function to check a single container
    check_container_status() {
        local container_name=$1
        local image_name=$2

        # Get running container's image ID
        local running_id=$($DOCKER_CMD inspect -f '{{.Image}}' "$container_name" 2>/dev/null | cut -d: -f2 | cut -c1-12)

        if [[ -z "$running_id" ]]; then
            echo "  ${RED}✗ $container_name - Not running${NC}"
            return
        fi

        # Get latest local image ID
        local latest_local_id=$($DOCKER_CMD images --format "{{.ID}}" "$image_name" 2>/dev/null | head -1)

        if [[ "$running_id" == "$latest_local_id" ]]; then
            if [[ "$pull_flag" == "--pull" ]]; then
                # Check remote for updates
                echo -n "  ⏳ $container_name - Checking remote... "
                local pull_output=$($DOCKER_CMD pull "$image_name" 2>&1)
                if echo "$pull_output" | grep -q "Downloaded newer image\|Pull complete"; then
                    echo "${YELLOW}Update available (pulled)${NC}"
                elif echo "$pull_output" | grep -q "Image is up to date"; then
                    echo "${GREEN}Up to date${NC}"
                else
                    echo "${YELLOW}Check failed${NC}"
                fi
            else
                echo "  ${GREEN}✓ $container_name - Up to date (local)${NC}"
            fi
        else
            # Update is available locally
            echo "  ${YELLOW}⚠ $container_name - Update ready${NC} (restart to apply)"
            echo "    Running: ${running_id} → Available: ${latest_local_id}"
        fi
    }

    # Process each project
    if [[ "$project" == "all" ]]; then
        for name path in ${(kv)COMPOSE_FILES}; do
            if [[ -f "$path" ]]; then
                echo "${BLUE}→ $name:${NC}"
                # Get all containers for this compose file
                local containers=$($DOCKER_CMD compose -f "$path" ps --format "{{.Name}}" 2>/dev/null)
                if [[ -z "$containers" ]]; then
                    echo "  ${YELLOW}No running containers${NC}"
                else
                    while IFS= read -r container; do
                        if [[ -n "$container" ]]; then
                            local image=$($DOCKER_CMD inspect -f '{{.Config.Image}}' "$container" 2>/dev/null)
                            if [[ -n "$image" ]]; then
                                check_container_status "$container" "$image"
                            fi
                        fi
                    done <<< "$containers"
                fi
                echo ""
            else
                echo "${RED}→ $name: Compose file not found${NC}"
                echo ""
            fi
        done
    elif [[ -n "${COMPOSE_FILES[$project]}" ]]; then
        if [[ -f "${COMPOSE_FILES[$project]}" ]]; then
            echo "${BLUE}→ $project:${NC}"
            local containers=$($DOCKER_CMD compose -f "${COMPOSE_FILES[$project]}" ps --format "{{.Name}}" 2>/dev/null)
            if [[ -z "$containers" ]]; then
                echo "  ${YELLOW}No running containers${NC}"
            else
                while IFS= read -r container; do
                    if [[ -n "$container" ]]; then
                        local image=$($DOCKER_CMD inspect -f '{{.Config.Image}}' "$container" 2>/dev/null)
                        if [[ -n "$image" ]]; then
                            check_container_status "$container" "$image"
                        fi
                    fi
                done <<< "$containers"
            fi
        else
            echo "${RED}Compose file not found: ${COMPOSE_FILES[$project]}${NC}"
            return 1
        fi
    else
        echo "${RED}Unknown project: $project${NC}"
        echo "Available: ${(k)COMPOSE_FILES} all"
        return 1
    fi

    # Show summary
    echo "${BLUE}Summary:${NC}"
    echo "  • ${GREEN}Green${NC} = Running latest version"
    echo "  • ${YELLOW}Yellow${NC} = Update available"
    echo "  • ${RED}Red${NC} = Container not running"
    echo ""
    echo "Use 'oc update <project>' to apply available updates"
    if [[ "$pull_flag" != "--pull" ]]; then
        echo "Use 'oc check <project> --pull' to check remote registries"
    fi
}

# Update containers
update_containers() {
    local project=$1
    local force_pull=$2  # Optional: --pull to force pull even if local updates exist

    if [[ -z "$project" ]]; then
        echo "${RED}Error: Please specify a project or 'all'${NC}"
        echo "Available: ${(k)COMPOSE_FILES} all"
        return 1
    fi

    echo "${BLUE}Updating containers...${NC}"
    echo ""

    # Function to update a single project
    update_project() {
        local name=$1
        local path=$2

        if [[ ! -f "$path" ]]; then
            echo "${RED}→ Skipping $name (compose file not found)${NC}"
            return 1
        fi

        echo "${YELLOW}→ Updating $name...${NC}"

        # First, check if we need to pull
        local need_pull=false
        local has_local_updates=false

        if [[ "$force_pull" == "--pull" ]]; then
            need_pull=true
            echo "  Forcing pull of latest images..."
        else
            # Check if any container has local updates available
            echo "  Checking for available updates..."
            local containers=$($DOCKER_CMD compose -f "$path" ps --format "{{.Name}}" 2>/dev/null)

            if [[ -z "$containers" ]]; then
                echo "  ${YELLOW}No running containers, will pull latest${NC}"
                need_pull=true
            else
                while IFS= read -r container; do
                    if [[ -n "$container" ]]; then
                        local image=$($DOCKER_CMD inspect -f '{{.Config.Image}}' "$container" 2>/dev/null)
                        local running_id=$($DOCKER_CMD inspect -f '{{.Image}}' "$container" 2>/dev/null | cut -d: -f2 | cut -c1-12)
                        local latest_id=$($DOCKER_CMD images --format "{{.ID}}" "$image" 2>/dev/null | head -1)

                        if [[ -n "$running_id" ]] && [[ -n "$latest_id" ]] && [[ "$running_id" != "$latest_id" ]]; then
                            has_local_updates=true
                            echo "  ${GREEN}✓ Found local updates for $container${NC}"
                        fi
                    fi
                done <<< "$containers"

                # If no local updates found, we should pull
                if [[ "$has_local_updates" == false ]]; then
                    echo "  No local updates found, pulling from registry..."
                    need_pull=true
                fi
            fi
        fi

        # Pull if needed
        if [[ "$need_pull" == true ]]; then
            echo "  Pulling latest images..."
            $DOCKER_CMD compose -f "$path" pull
        fi

        # Recreate containers
        echo "  Recreating containers..."
        $DOCKER_CMD compose -f "$path" up -d

        echo "${GREEN}✓ $name updated${NC}"
        echo ""
    }

    # Confirm before proceeding
    if [[ "$project" != "all" ]] || [[ "$force_pull" != "--pull" ]]; then
        echo "${YELLOW}This will restart containers to apply updates.${NC}"
    else
        echo "${YELLOW}This will pull latest images and restart all containers.${NC}"
    fi
    echo -n "Continue? (y/N): "
    read confirm
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
        echo "Cancelled."
        return 0
    fi
    echo ""

    # Update projects
    if [[ "$project" == "all" ]]; then
        for name path in ${(kv)COMPOSE_FILES}; do
            update_project "$name" "$path"
        done
    elif [[ -n "${COMPOSE_FILES[$project]}" ]]; then
        update_project "$project" "${COMPOSE_FILES[$project]}"
    else
        echo "${RED}Unknown project: $project${NC}"
        echo "Available: ${(k)COMPOSE_FILES} all"
        return 1
    fi

    # Clean up old images
    echo "${YELLOW}Cleaning up old images...${NC}"
    $DOCKER_CMD image prune -f
    echo ""
    echo "${GREEN}Update complete!${NC}"
}

# Main command router
case "$1" in
    start)
        shift
        start_projects "$@"
        ;;
    stop)
        shift
        stop_projects "$@"
        ;;
    down|remove)
        shift
        down_projects "$@"
        ;;
    restart)
        shift
        restart_projects "$@"
        ;;
    status|ls)
        show_status
        ;;
    logs|log)
        shift
        show_logs "$@"
        ;;
    ps)
        shift
        show_ps "$@"
        ;;
    exec)
        shift
        exec_in_service "$@"
        ;;
    check)
        shift
        check_updates "$@"
        ;;
    update|upgrade)
        shift
        update_containers "$@"
        ;;
    -h|--help|help)
        usage
        ;;
    *)
        if [[ -z "$1" ]]; then
            usage
        else
            echo "${RED}Unknown command: $1${NC}"
            echo ""
            usage
            exit 1
        fi
        ;;
esac
