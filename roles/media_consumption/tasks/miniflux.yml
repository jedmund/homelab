---
- name: Deploy Miniflux RSS Reader
  community.docker.docker_container:
    name: miniflux
    image: miniflux/miniflux:latest
    state: started
    restart_policy: "{{ restart_policy }}"
    networks:
      - name: "{{ shared_network }}"
      - name: "{{ backend_network }}"
    ports:
      - "{{ miniflux_port }}:8080"
    env:
      TZ: "{{ timezone }}"
      DATABASE_URL: "{{ miniflux_database_url }}"
      BASE_URL: "{{ miniflux_base_url }}"
      RUN_MIGRATIONS: "1"
      CREATE_ADMIN: "1"
      ADMIN_USERNAME: "{{ miniflux_admin_username }}"
      ADMIN_PASSWORD: "{{ miniflux_admin_password }}"
      DISABLE_LOCAL_AUTH: "{{ miniflux_disable_local_auth }}"
      OAUTH2_PROVIDER: "{{ miniflux_oauth2_provider }}"
      OAUTH2_OIDC_PROVIDER_NAME: "{{ miniflux_oauth2_oidc_provider_name }}"
      OAUTH2_CLIENT_ID: "{{ miniflux_oauth2_client_id }}"
      OAUTH2_CLIENT_SECRET: "{{ miniflux_oauth2_client_secret }}"
      OAUTH2_REDIRECT_URL: "{{ miniflux_oauth2_redirect_url }}"
      OAUTH2_OIDC_DISCOVERY_ENDPOINT: "{{ miniflux_oauth2_oidc_discovery_endpoint }}"
      OAUTH2_USER_CREATION: "{{ miniflux_oauth2_user_creation }}"
      POLLING_FREQUENCY: "{{ miniflux_polling_frequency }}"
      BATCH_SIZE: "{{ miniflux_batch_size }}"
      POLLING_PARSING_ERROR_LIMIT: "{{ miniflux_polling_parsing_error_limit }}"
      WORKER_POOL_SIZE: "{{ miniflux_worker_pool_size }}"
      METRICS_COLLECTOR: "{{ miniflux_metrics_collector }}"
      METRICS_ALLOWED_NETWORKS: "{{ miniflux_metrics_allowed_networks }}"
    healthcheck:
      test: ["CMD", "/usr/bin/miniflux", "-healthcheck", "auto"]
      interval: "{{ healthcheck_interval }}"
      timeout: "{{ healthcheck_timeout }}"
      retries: "{{ healthcheck_retries }}"
    log_driver: "{{ logging_driver }}"
    log_options:
      max-size: "{{ logging_max_size }}"
      max-file: "{{ logging_max_file }}"
