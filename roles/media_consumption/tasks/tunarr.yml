---
- name: Ensure render group exists for Intel Arc
  group:
    name: render
    state: present
  when: gpu_type == 'intel_arc'

- name: Get render group ID
  command: getent group render
  register: render_group
  changed_when: false
  when: gpu_type == 'intel_arc'

- name: Get video group ID
  command: getent group video
  register: video_group
  changed_when: false
  when: gpu_type == 'intel_arc'

- name: Deploy Tunarr virtual channel creator with Intel Arc GPU
  community.docker.docker_container:
    name: tunarr
    image: chrisbenincasa/tunarr:latest
    state: started
    restart_policy: "{{ restart_policy }}"
    networks:
      - name: "{{ shared_network }}"
    ports:
      - "{{ tunarr_port }}:8000"
    env:
      TZ: "{{ timezone }}"
      DATABASE_URL: "{{ tunarr_database_url }}"
      LOG_LEVEL: INFO
    devices: "{{ docker_devices }}"
    # Use 'groups' parameter with numeric GIDs
    groups:
      - "{{ render_group.stdout.split(':')[2] }}"
      - "{{ video_group.stdout.split(':')[2] }}"
    volumes:
      - "{{ config_base }}/tunarr:/config/tunarr"
      - videos:/videos:ro
      - television:/television:ro
      - anime:/anime:ro
      - movies:/movies:ro
    log_driver: "{{ logging_driver }}"
    log_options:
      max-size: "{{ logging_max_size }}"
      max-file: "{{ logging_max_file }}"
  when: gpu_type == 'intel_arc'

- name: Display Tunarr setup instructions
  debug:
    msg:
      - "Tunarr deployed successfully with Intel Arc GPU support!"
      - "Access it at: http://{{ ansible_host }}:{{ tunarr_port }}"
      - ""
      - "Intel QuickSync hardware acceleration is ENABLED"
      - ""
      - "Next steps:"
      - "1. Go to Settings > FFmpeg in Tunarr web UI"
      - "2. Verify hardware acceleration options are available"
      - "3. Create a Transcode Configuration with Intel QuickSync selected"
      - "4. Add your Plex server as a media source (Settings > Media Sources)"
      - "5. Create custom channels from your media libraries"
      - "6. Configure EPG (Electronic Program Guide)"
      - "7. Add Tunarr as a Live TV source in Plex"
      - ""
      - "Hardware acceleration will be configured per-channel in the Tunarr UI."
  when: gpu_type == 'intel_arc'
