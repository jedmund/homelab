---
- name: Create local Docker volumes for Romm
  community.docker.docker_volume:
    name: "{{ item }}"
    state: present
  loop:
    - romm_mysql_data
    - romm_resources
    - romm_redis_data

- name: Deploy Romm MariaDB database
  community.docker.docker_container:
    name: romm-db
    image: mariadb:latest
    state: started
    restart_policy: "{{ restart_policy }}"
    networks:
      - name: "{{ backend_network }}"
    env:
      MYSQL_ROOT_PASSWORD: "{{ romm_db_root_password }}"
      MYSQL_DATABASE: "{{ romm_db_name }}"
      MYSQL_USER: "{{ romm_db_user }}"
      MYSQL_PASSWORD: "{{ romm_db_password }}"
      MARIADB_ROOT_PASSWORD: "{{ romm_db_root_password }}"
      MARIADB_DATABASE: "{{ romm_db_name }}"
      MARIADB_USER: "{{ romm_db_user }}"
      MARIADB_PASSWORD: "{{ romm_db_password }}"
    volumes:
      - romm_mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      start_period: "{{ healthcheck_start_period }}"
      start_interval: 10s
      interval: 10s
      timeout: 5s
      retries: 5
    log_driver: "{{ logging_driver }}"
    log_options:
      max-size: "5m"
      max-file: "{{ logging_max_file }}"

- name: Deploy Romm game library manager
  community.docker.docker_container:
    name: romm
    image: rommapp/romm:latest
    state: started
    restart_policy: "{{ restart_policy }}"
    networks:
      - name: "{{ shared_network }}"
      - name: "{{ backend_network }}"
    ports:
      - "{{ romm_port }}:8080"
    env:
      TZ: "{{ timezone }}"
      # Auth
      ROMM_AUTH_SECRET_KEY: "{{ romm_auth_secret_key }}"
      DISABLE_USERPASS_LOGIN: "{{ romm_disable_userpass_login }}"
      DISABLE_CSRF_PROTECTION: "{{ romm_disable_csrf_protection }}"
      KIOSK_MODE: "{{ romm_kiosk_mode }}"
      # Timeouts
      UPLOAD_TIMEOUT: "{{ romm_upload_timeout }}"
      SCAN_TIMEOUT: "{{ romm_scan_timeout }}"
      # Features
      DISABLE_EMULATOR_JS: "{{ romm_disable_emulator_js }}"
      DISABLE_RUFFLE_RS: "{{ romm_disable_ruffle_rs }}"
      # Performance
      WEB_CONCURRENCY: "{{ romm_web_concurrency }}"
      LOGLEVEL: "{{ romm_loglevel }}"
      # Database
      DB_HOST: "{{ romm_db_host }}"
      DB_PORT: "{{ romm_db_port | string }}"
      DB_NAME: "{{ romm_db_name }}"
      DB_USER: "{{ romm_db_user }}"
      DB_PASSWD: "{{ romm_db_password }}"
      ROMM_DB_DRIVER: "{{ romm_db_driver }}"
      # Metadata providers
      HASHEOUS_API_ENABLED: "{{ romm_hasheous_api_enabled }}"
      HLTB_API_ENABLED: "{{ romm_hltb_api_enabled }}"
      IGDB_CLIENT_ID: "{{ romm_igdb_client_id }}"
      IGDB_CLIENT_SECRET: "{{ romm_igdb_client_secret }}"
      SCREENSCRAPER_USER: "{{ romm_screenscraper_user }}"
      SCREENSCRAPER_PASSWORD: "{{ romm_screenscraper_password }}"
      RETROACHIEVEMENTS_API_KEY: "{{ romm_retroachievements_api_key }}"
      STEAMGRIDDB_API_KEY: "{{ romm_steamgriddb_api_key }}"
      MOBYGAMES_API_KEY: "{{ romm_mobygames_api_key }}"
      # OIDC
      OIDC_ENABLED: "{{ romm_oidc_enabled }}"
      OIDC_PROVIDER: "{{ romm_oidc_provider }}"
      OIDC_CLIENT_ID: "{{ romm_oidc_client_id }}"
      OIDC_CLIENT_SECRET: "{{ romm_oidc_client_secret }}"
      OIDC_REDIRECT_URI: "{{ romm_oidc_redirect_uri }}"
      OIDC_SERVER_APPLICATION_URL: "{{ romm_oidc_server_application_url }}"
      # Background tasks
      ENABLE_RESCAN_ON_FILESYSTEM_CHANGE: "{{ romm_enable_rescan_on_filesystem_change }}"
      RESCAN_ON_FILESYSTEM_CHANGE_DELAY: "{{ romm_rescan_on_filesystem_change_delay }}"
      ENABLE_SCHEDULED_RESCAN: "{{ romm_enable_scheduled_rescan }}"
      SCHEDULED_RESCAN_CRON: "{{ romm_scheduled_rescan_cron }}"
      ENABLE_SCHEDULED_UPDATE_SWITCH_TITLEDB: "{{ romm_enable_scheduled_update_switch_titledb }}"
      SCHEDULED_UPDATE_SWITCH_TITLEDB_CRON: "{{ romm_scheduled_update_switch_titledb_cron }}"
    volumes:
      - romm_resources:/romm/resources
      - romm_redis_data:/redis-data
      - games:/romm/library
      - games_assets:/romm/assets
      - "{{ config_base }}/romm:/romm/config"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080"]
      interval: "{{ healthcheck_interval }}"
      timeout: "{{ healthcheck_timeout }}"
      retries: "{{ healthcheck_retries }}"
      start_period: "{{ healthcheck_start_period }}"
    log_driver: "{{ logging_driver }}"
    log_options:
      max-size: "{{ logging_max_size }}"
      max-file: "{{ logging_max_file }}"
