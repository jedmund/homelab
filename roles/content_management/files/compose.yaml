name: content-management
services:
  # Immich
  immich-server:
    container_name: immich_server
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}
    volumes:
      - photos:/usr/src/app/upload
      - /etc/localtime:/etc/localtime:ro
    env_file:
      - ./env/immich.env
    ports:
      - '2283:2283'
    depends_on:
      - immich-redis
      - immich-database
    restart: always
    healthcheck:
      disable: false

  immich-machine-learning:
    container_name: immich_machine_learning
    image: ghcr.io/immich-app/immich-machine-learning:${IMMICH_VERSION:-release}
    volumes:
      - model-cache:/cache
    env_file:
      - ./env/immich.env
    restart: always
    healthcheck:
      disable: false

  immich-redis:
    container_name: immich_redis
    image: docker.io/valkey/valkey:8-bookworm@sha256:fec42f399876eb6faf9e008570597741c87ff7662a54185593e74b09ce83d177
    healthcheck:
      test: redis-cli ping || exit 1
    restart: always

  immich-database:
    container_name: immich_postgres
    image: ghcr.io/immich-app/postgres:14-vectorchord0.4.3-pgvectors0.2.0
    env_file:
      - ./env/immich.env
    volumes: 
      - immich-pgdata:/var/lib/postgresql/data
    restart: always

  # =============================================================================
  # Papra - Document Management (replaces Paperless-ngx)
  # =============================================================================
  papra:
    container_name: papra
    image: ghcr.io/papra-hq/papra:latest
    restart: unless-stopped
    ports:
      - "8787:1221"
    volumes:
      - papra-data:/app/data
      - papra-documents:/app/documents
    env_file:
      - ./env/papra.env
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =============================================================================
  # COMMENTED OUT - Paperless-ngx (replaced by Papra)
  # Keep data volumes intact for potential migration
  # =============================================================================

  # paperless-broker:
  #   container_name: paperless_redis
  #   image: docker.io/library/redis:8
  #   restart: unless-stopped
  #   volumes:
  #     - paperless-redisdata:/data
  #   env_file:
  #     - ./env/paperless.env

  # paperless-db:
  #   container_name: paperless_postgres
  #   image: docker.io/library/postgres:17
  #   restart: unless-stopped
  #   volumes:
  #     - paperless-pgdata:/var/lib/postgresql/data
  #   env_file:
  #     - ./env/paperless.env

  # paperless-webserver:
  #   container_name: paperless_web
  #   image: ghcr.io/paperless-ngx/paperless-ngx:latest
  #   restart: unless-stopped
  #   depends_on:
  #     - paperless-db
  #     - paperless-broker
  #   ports:
  #     - "8787:8000"
  #   volumes:
  #     - paperless-data:/usr/src/paperless/data
  #     - paperless-media:/usr/src/paperless/media
  #     - paperless-export:/usr/src/paperless/export
  #     - paperless-consume:/usr/src/paperless/consume
  #   env_file:
  #     - ./env/paperless.env
  #   environment:
  #     PAPERLESS_REDIS: redis://paperless-broker:6379
  #     PAPERLESS_DBHOST: paperless-db

  # paperless-backup:
  #   container_name: paperless_backup
  #   image: docker.io/library/postgres:17
  #   restart: unless-stopped
  #   depends_on:
  #     - paperless-db
  #   env_file:
  #     - ./env/paperless.env
  #   environment:
  #     - PGHOST=paperless-db
  #     - PGUSER=paperless
  #     - PGPASSWORD=${PAPERLESS_DB_PASSWORD:-paperless}
  #     - TZ=${TZ:-America/Los_Angeles}
  #   volumes:
  #     - ./backups/paperless:/backup
  #     - paperless-data:/usr/src/paperless/data:ro
  #     - paperless-media:/usr/src/paperless/media:ro
  #   entrypoint: |
  #     sh -c 'while true; do
  #       echo "Backing up Paperless database..."
  #       pg_dump -U paperless paperless > /backup/paperless_db_$$(date +%Y%m%d_%H%M%S).sql
  #       echo "Document export should be done via Paperless web interface or CLI"
  #       ls -t /backup/paperless_db_*.sql | tail -n +8 | xargs -r rm
  #       echo "Backup complete. Sleeping for 24 hours..."
  #       sleep 86400
  #     done'

  # SongKong Music Manager
  songkong:
    container_name: songkong
    image: songkong/songkong:latest
    restart: unless-stopped
    ports:
      - "4567:4567"
    volumes:
      - songkong-config:/songkong
      - music:/music
    environment:
      - TZ=${TZ:-America/Los_Angeles}

volumes:
  # Local volumes (database data)
  immich-pgdata:
    external: true
    name: immich-pgdata
  model-cache:
  songkong-config:
  papra-data:

  # Paperless volumes (kept for potential data migration)
  # paperless-data:
  # paperless-pgdata:
  # paperless-redisdata:

  # Network storage (NFS external volumes)
  photos:
    external: true
  papra-documents:
    external: true
  music:
    external: true

networks:
  default:
    name: shared-network
    external: true
