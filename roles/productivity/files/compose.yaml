name: productivity

services:
  # =============================================================================
  # Strudel - Live Coding Music Environment
  # =============================================================================
  strudel:
    container_name: strudel
    build:
      context: ./config/strudel
      dockerfile: Dockerfile
    restart: unless-stopped
    networks:
      - proxy
    labels:
      traefik.enable: "true"
      traefik.http.routers.strudel.rule: "Host(`strudel.atelier.house`)"
      traefik.http.routers.strudel.entrypoints: "websecure"
      traefik.http.routers.strudel.tls.certresolver: "letsencrypt"
      traefik.http.services.strudel.loadbalancer.server.port: "80"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =============================================================================
  # Silverbullet - Markdown PKM/Wiki
  # =============================================================================
  silverbullet:
    container_name: silverbullet
    image: zefhemel/silverbullet:latest
    restart: unless-stopped
    networks:
      - proxy
    volumes:
      - silverbullet-space:/space
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =============================================================================
  # Blinko - AI-Powered Card Notes
  # =============================================================================
  blinko:
    container_name: blinko
    image: blinkospace/blinko:latest
    restart: unless-stopped
    networks:
      - proxy
      - backend
    volumes:
      - blinko-data:/app/.blinko
    env_file:
      - ./env/blinko.env
    depends_on:
      blinko-db:
        condition: service_healthy
    labels:
      traefik.enable: "true"
      traefik.http.routers.blinko.rule: "Host(`bl.atelier.house`)"
      traefik.http.routers.blinko.entrypoints: "websecure"
      traefik.http.routers.blinko.tls.certresolver: "letsencrypt"
      traefik.http.services.blinko.loadbalancer.server.port: "1111"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =============================================================================
  # Blinko PostgreSQL Database
  # =============================================================================
  blinko-db:
    container_name: blinko_postgres
    image: postgres:14-alpine
    restart: unless-stopped
    networks:
      - backend
    volumes:
      - blinko-pgdata:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=blinko
      - POSTGRES_USER=blinko
      - POSTGRES_PASSWORD=${BLINKO_DB_PASSWORD}
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "blinko"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

volumes:
  silverbullet-space:
  blinko-data:
  blinko-pgdata:

networks:
  proxy:
    name: proxy-network
    external: true
  backend:
    name: backend-internal
    external: true
