---
- name: Deploy PocketID OIDC provider
  community.docker.docker_container:
    name: pocketid
    image: ghcr.io/pocket-id/pocket-id:latest
    state: started
    restart_policy: "{{ restart_policy }}"
    networks:
      - name: "{{ proxy_network }}"
    env:
      TZ: "{{ timezone }}"
      APP_URL: "{{ pocketid_app_url }}"
      TRUST_PROXY: "{{ pocketid_trust_proxy }}"
      ENCRYPTION_KEY: "{{ pocketid_encryption_key }}"
      EMAIL_LOGIN_NOTIFICATION_ENABLED: "{{ pocketid_email_login_notification_enabled }}"
    volumes:
      - "{{ config_base }}/pocketid/data:/app/data"
    labels:
      traefik.enable: "true"
      traefik.http.routers.pocketid.rule: "Host(`id.{{ traefik_domain }}`)"
      traefik.http.routers.pocketid.entrypoints: "websecure"
      traefik.http.routers.pocketid.tls.certresolver: "letsencrypt"
      traefik.http.services.pocketid.loadbalancer.server.port: "{{ pocketid_port }}"
    log_driver: "{{ logging_driver }}"
    log_options:
      max-size: "{{ logging_max_size }}"
      max-file: "{{ logging_max_file }}"
