# {{ ansible_managed }}
name: {{ stack_name }}

services:
  traefik:
    container_name: traefik
    image: {{ traefik_image }}
    restart: {{ restart_policy }}
    networks:
      - proxy
      - backend
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./config/traefik/dynamic:/config/dynamic:ro
      - ./config/traefik/acme:/config/acme
      - traefik-logs:/var/log/traefik
    env_file:
      - ./env/traefik.env
    labels:
      traefik.enable: "true"
    logging:
      driver: {{ logging_driver }}
      options:
        max-size: {{ logging_max_size }}
        max-file: {{ logging_max_file }}
    healthcheck:
      test: ["CMD", "traefik", "healthcheck"]
      interval: {{ healthcheck_interval }}
      timeout: {{ healthcheck_timeout }}
      retries: {{ healthcheck_retries }}

  pocketid:
    container_name: pocketid
    image: ghcr.io/pocket-id/pocket-id:latest
    restart: {{ restart_policy }}
    networks:
      - proxy
    volumes:
      - ./config/pocketid/data:/app/data
    env_file:
      - ./env/pocketid.env
    labels:
      traefik.enable: "true"
      traefik.http.routers.pocketid.rule: "Host(`id.{{ traefik_domain }}`)"
      traefik.http.routers.pocketid.entrypoints: "websecure"
      traefik.http.routers.pocketid.tls.certresolver: "letsencrypt"
      traefik.http.services.pocketid.loadbalancer.server.port: "{{ pocketid_port }}"
    logging:
      driver: {{ logging_driver }}
      options:
        max-size: {{ logging_max_size }}
        max-file: {{ logging_max_file }}

  tinyauth:
    container_name: tinyauth
    image: ghcr.io/steveiliop56/tinyauth:v4
    restart: {{ restart_policy }}
    networks:
      - proxy
    env_file:
      - ./env/tinyauth.env
    labels:
      traefik.enable: "true"
      traefik.http.routers.tinyauth.rule: "Host(`auth.{{ traefik_domain }}`)"
      traefik.http.routers.tinyauth.entrypoints: "websecure"
      traefik.http.routers.tinyauth.tls.certresolver: "letsencrypt"
      traefik.http.services.tinyauth.loadbalancer.server.port: "{{ tinyauth_port }}"
      tinyauth.apps.stash.config.domain: "z.{{ traefik_domain }}"
      tinyauth.apps.stash.users.allow: "{{ tinyauth_allowed_user }}"
      tinyauth.apps.flood.config.domain: "flood.{{ traefik_domain }}"
      tinyauth.apps.flood.users.allow: "{{ tinyauth_allowed_user }}"
      tinyauth.apps.silverbullet.config.domain: "notes.{{ traefik_domain }}"
      tinyauth.apps.silverbullet.users.allow: "{{ tinyauth_allowed_user }}"
      tinyauth.apps.pinchflat.config.domain: "pi.{{ traefik_domain }}"
      tinyauth.apps.pinchflat.users.allow: "{{ tinyauth_allowed_user }}"
    logging:
      driver: {{ logging_driver }}
      options:
        max-size: "5m"
        max-file: {{ logging_max_file }}

  ddclient:
    container_name: ddclient
    restart: {{ restart_policy }}
    image: linuxserver/ddclient
    networks:
      - proxy
    volumes:
      - ./config/ddclient/config.conf:/etc/ddclient/ddclient.conf
    logging:
      driver: {{ logging_driver }}
      options:
        max-size: {{ logging_max_size }}
        max-file: {{ logging_max_file }}

  openspeedtest:
    container_name: openspeedtest
    restart: {{ restart_policy }}
    image: openspeedtest/latest
    networks:
      - proxy
    labels:
      traefik.enable: "true"
      traefik.http.routers.speedtest.rule: "Host(`speed.{{ traefik_domain }}`)"
      traefik.http.routers.speedtest.entrypoints: "websecure"
      traefik.http.routers.speedtest.tls.certresolver: "letsencrypt"
      traefik.http.services.speedtest.loadbalancer.server.port: "{{ openspeedtest_port }}"
    logging:
      driver: {{ logging_driver }}
      options:
        max-size: {{ logging_max_size }}
        max-file: {{ logging_max_file }}

  glance:
    container_name: glance
    image: glanceapp/glance
    restart: {{ restart_policy }}
    networks:
      - proxy
      - shared
    volumes:
      - ./config/glance:/app/config
      - ./assets:/app/assets
    env_file: ./env/glance.env
    labels:
      traefik.enable: "true"
      traefik.http.routers.glance.rule: "Host(`{{ traefik_domain }}`) || Host(`start.{{ traefik_domain }}`)"
      traefik.http.routers.glance.entrypoints: "websecure"
      traefik.http.routers.glance.tls.certresolver: "letsencrypt"
      traefik.http.services.glance.loadbalancer.server.port: "{{ glance_port }}"
    logging:
      driver: {{ logging_driver }}
      options:
        max-size: {{ logging_max_size }}
        max-file: {{ logging_max_file }}

  adguard:
    container_name: adguard
    image: adguard/adguardhome:latest
    restart: {{ restart_policy }}
    networks:
      - proxy
    ports:
      - "{{ adguard_port_dns_tcp }}:53/tcp"
      - "{{ adguard_port_dns_udp }}:53/udp"
      - "{{ adguard_port_setup }}:3000/tcp"
    volumes:
      - ./config/adguard/work:/opt/adguardhome/work
      - ./config/adguard/conf:/opt/adguardhome/conf
    labels:
      traefik.enable: "true"
      traefik.http.routers.adguard.rule: "Host(`dns.{{ traefik_domain }}`)"
      traefik.http.routers.adguard.entrypoints: "websecure"
      traefik.http.routers.adguard.tls.certresolver: "letsencrypt"
      traefik.http.services.adguard.loadbalancer.server.port: "{{ adguard_port_http }}"
    logging:
      driver: {{ logging_driver }}
      options:
        max-size: {{ logging_max_size }}
        max-file: {{ logging_max_file }}

volumes:
  traefik-logs:
    name: {{ stack_name }}_traefik-logs

networks:
  proxy:
    name: {{ proxy_network }}
    external: true
  backend:
    name: {{ backend_network }}
    external: true
  shared:
    name: {{ shared_network }}
    external: true
