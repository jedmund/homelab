name: infra-gateway

services:
  # =============================================================================
  # Traefik Reverse Proxy
  # =============================================================================
  traefik:
    container_name: traefik
    image: traefik:v3.6
    restart: unless-stopped
    networks:
      - proxy
      - backend
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./config/traefik/dynamic:/config/dynamic:ro
      - ./config/traefik/acme:/config/acme
      - traefik-logs:/var/log/traefik
    env_file:
      - ./env/traefik.env
    labels:
      traefik.enable: "true"
      # Dashboard route defined in config/traefik/dynamic/services-mini.yml
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "traefik", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =============================================================================
  # PocketID - Passkey-based OIDC Provider
  # =============================================================================
  pocketid:
    container_name: pocketid
    image: ghcr.io/pocket-id/pocket-id:latest
    restart: unless-stopped
    networks:
      - proxy
    volumes:
      - ./config/pocketid/data:/app/data
    env_file:
      - ./env/pocketid.env
    labels:
      traefik.enable: "true"
      traefik.http.routers.pocketid.rule: "Host(`id.atelier.house`)"
      traefik.http.routers.pocketid.entrypoints: "websecure"
      traefik.http.routers.pocketid.tls.certresolver: "letsencrypt"
      traefik.http.services.pocketid.loadbalancer.server.port: "1411"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =============================================================================
  # TinyAuth - Forward Authentication Middleware
  # =============================================================================
  tinyauth:
    container_name: tinyauth
    image: ghcr.io/steveiliop56/tinyauth:v4
    restart: unless-stopped
    networks:
      - proxy
    env_file:
      - ./env/tinyauth.env
    labels:
      traefik.enable: "true"
      traefik.http.routers.tinyauth.rule: "Host(`auth.atelier.house`)"
      traefik.http.routers.tinyauth.entrypoints: "websecure"
      traefik.http.routers.tinyauth.tls.certresolver: "letsencrypt"
      traefik.http.services.tinyauth.loadbalancer.server.port: "3000"
      # Access control for external services
      tinyauth.apps.stash.config.domain: "z.atelier.house"
      tinyauth.apps.stash.users.allow: "justin@jedmund.com"
      tinyauth.apps.flood.config.domain: "flood.atelier.house"
      tinyauth.apps.flood.users.allow: "justin@jedmund.com"
      tinyauth.apps.silverbullet.config.domain: "notes.atelier.house"
      tinyauth.apps.silverbullet.users.allow: "justin@jedmund.com"
      tinyauth.apps.pinchflat.config.domain: "pi.atelier.house"
      tinyauth.apps.pinchflat.users.allow: "justin@jedmund.com"
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  # =============================================================================
  # DDClient - Dynamic DNS
  # =============================================================================
  ddclient:
    container_name: ddclient
    restart: unless-stopped
    image: linuxserver/ddclient
    networks:
      - proxy
    volumes:
      - ./config/ddclient/config.conf:/etc/ddclient/ddclient.conf
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =============================================================================
  # OpenSpeedTest
  # =============================================================================
  openspeedtest:
    container_name: openspeedtest
    restart: unless-stopped
    image: openspeedtest/latest
    networks:
      - proxy
    labels:
      traefik.enable: "true"
      traefik.http.routers.speedtest.rule: "Host(`speed.atelier.house`)"
      traefik.http.routers.speedtest.entrypoints: "websecure"
      traefik.http.routers.speedtest.tls.certresolver: "letsencrypt"
      traefik.http.services.speedtest.loadbalancer.server.port: "3000"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =============================================================================
  # Glance Dashboard
  # =============================================================================
  glance:
    container_name: glance
    image: glanceapp/glance
    restart: unless-stopped
    networks:
      - proxy
      - shared
    volumes:
      - ./config/glance:/app/config
      - ./assets:/app/assets
    env_file: ./env/glance.env
    labels:
      traefik.enable: "true"
      traefik.http.routers.glance.rule: "Host(`atelier.house`) || Host(`start.atelier.house`)"
      traefik.http.routers.glance.entrypoints: "websecure"
      traefik.http.routers.glance.tls.certresolver: "letsencrypt"
      traefik.http.services.glance.loadbalancer.server.port: "8080"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =============================================================================
  # AdGuard Home - Network-wide Ad Blocking
  # =============================================================================
  adguard:
    container_name: adguard
    image: adguard/adguardhome:latest
    restart: unless-stopped
    networks:
      - proxy
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "3000:3000/tcp"
    volumes:
      - ./config/adguard/work:/opt/adguardhome/work
      - ./config/adguard/conf:/opt/adguardhome/conf
    labels:
      traefik.enable: "true"
      traefik.http.routers.adguard.rule: "Host(`dns.atelier.house`)"
      traefik.http.routers.adguard.entrypoints: "websecure"
      traefik.http.routers.adguard.tls.certresolver: "letsencrypt"
      traefik.http.services.adguard.loadbalancer.server.port: "80"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =============================================================================
  # COMMENTED OUT - Pi-hole (replaced by AdGuard Home)
  # =============================================================================
  # pihole:
  #   container_name: pihole
  #   image: pihole/pihole:latest
  #   restart: unless-stopped
  #   networks:
  #     - proxy
  #   ports:
  #     - "53:53/tcp"
  #     - "53:53/udp"
  #   volumes:
  #     - ./config/pihole/etc:/etc/pihole
  #     - ./config/pihole/dnsmasq:/etc/dnsmasq.d
  #   env_file:
  #     - ./env/pihole.env
  #   labels:
  #     traefik.enable: "true"
  #     traefik.http.routers.pihole.rule: "Host(`dns.atelier.house`)"
  #     traefik.http.routers.pihole.entrypoints: "websecure"
  #     traefik.http.routers.pihole.tls.certresolver: "letsencrypt"
  #     traefik.http.services.pihole.loadbalancer.server.port: "80"
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "10m"
  #       max-file: "3"

  # =============================================================================
  # COMMENTED OUT - NPMplus (keeping for rollback)
  # Uncomment and change Traefik ports if needed for parallel testing
  # =============================================================================
  # npmplus:
  #   container_name: npmplus
  #   image: docker.io/zoeyvid/npmplus:latest
  #   restart: unless-stopped
  #   networks:
  #     - proxy
  #     - backend
  #   ports:
  #     - 8080:80    # Changed from 80 for parallel testing
  #     - 8443:443   # Changed from 443 for parallel testing
  #     - 8181:81    # Admin interface
  #   volumes:
  #     - ./config/npm:/data
  #   env_file:
  #     - ./env/npmplus.env
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "10m"
  #       max-file: "3"
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:80"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

  # =============================================================================
  # COMMENTED OUT - Authentik (replaced by PocketID + TinyAuth)
  # =============================================================================
  # authentik-postgresql:
  #   image: docker.io/library/postgres:16-alpine
  #   restart: unless-stopped
  #   networks:
  #     - backend
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}"]
  #     start_period: 20s
  #     interval: 30s
  #     retries: 5
  #     timeout: 5s
  #   volumes:
  #     - authentik-database:/var/lib/postgresql/data
  #   env_file:
  #     - ./env/authentik.env
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "10m"
  #       max-file: "3"

  # authentik-redis:
  #   image: docker.io/library/redis:alpine
  #   command: --save 60 1 --loglevel warning
  #   restart: unless-stopped
  #   networks:
  #     - backend
  #   healthcheck:
  #     test: ["CMD-SHELL", "redis-cli ping | grep PONG"]
  #     start_period: 20s
  #     interval: 30s
  #     retries: 5
  #     timeout: 3s
  #   volumes:
  #     - authentik-redis:/data
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "5m"
  #       max-file: "3"

  # authentik-server:
  #   image: ${AUTHENTIK_IMAGE:-ghcr.io/goauthentik/server}:${AUTHENTIK_TAG:-2025.8.4}
  #   restart: unless-stopped
  #   command: server
  #   networks:
  #     - proxy
  #     - shared
  #     - backend
  #   volumes:
  #     - ./media:/media
  #     - ./custom-templates:/templates
  #   env_file:
  #     - ./env/authentik.env
  #   ports:
  #     - "${COMPOSE_PORT_HTTP:-9000}:9000"
  #     - "${COMPOSE_PORT_HTTPS:-9443}:9443"
  #   depends_on:
  #     authentik-postgresql:
  #       condition: service_healthy
  #     authentik-redis:
  #       condition: service_healthy
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "10m"
  #       max-file: "3"

  # authentik-worker:
  #   image: ${AUTHENTIK_IMAGE:-ghcr.io/goauthentik/server}:${AUTHENTIK_TAG:-2025.8.4}
  #   restart: unless-stopped
  #   command: worker
  #   user: root
  #   networks:
  #     - backend
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock
  #     - ./media:/media
  #     - ./certs:/certs
  #     - ./custom-templates:/templates
  #   env_file:
  #     - ./env/authentik.env
  #   depends_on:
  #     authentik-postgresql:
  #       condition: service_healthy
  #     authentik-redis:
  #       condition: service_healthy
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "10m"
  #       max-file: "3"

volumes:
  traefik-logs:
    name: infra-gateway_traefik-logs
  # Commented out - no longer needed after migration complete
  # authentik-database:
  #   name: infrastructure_authentik-database
  #   external: true
  # authentik-redis:
  #   name: infrastructure_authentik-redis
  #   external: true

networks:
  proxy:
    name: proxy-network
    external: true
  backend:
    name: backend-internal
    external: true
  shared:
    name: shared-network
    external: true
