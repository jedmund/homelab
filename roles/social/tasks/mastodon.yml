---
- name: Create Mastodon volumes
  community.docker.docker_volume:
    name: "{{ item }}"
  loop:
    - mastodon-pgdata
    - mastodon-redis

- name: Deploy Mastodon Redis
  community.docker.docker_container:
    name: mastodon-redis
    image: "{{ mastodon_redis_image }}"
    state: started
    restart_policy: "{{ restart_policy }}"
    networks:
      - name: "{{ backend_network }}"
    volumes:
      - mastodon-redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    log_driver: "{{ logging_driver }}"
    log_options:
      max-size: "5m"
      max-file: "{{ logging_max_file }}"

- name: Deploy Mastodon PostgreSQL database
  community.docker.docker_container:
    name: mastodon-db
    image: "{{ mastodon_db_image }}"
    state: started
    restart_policy: "{{ restart_policy }}"
    networks:
      - name: "{{ backend_network }}"
    env:
      POSTGRES_USER: "{{ mastodon_db_user }}"
      POSTGRES_PASSWORD: "{{ mastodon_db_password }}"
      POSTGRES_DB: "{{ mastodon_db_name }}"
    volumes:
      - mastodon-pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "{{ mastodon_db_user }}", "-d", "{{ mastodon_db_name }}"]
      interval: 10s
      timeout: 5s
      retries: 5
    log_driver: "{{ logging_driver }}"
    log_options:
      max-size: "5m"
      max-file: "{{ logging_max_file }}"

- name: Deploy Mastodon Web
  community.docker.docker_container:
    name: mastodon-web
    image: "{{ mastodon_image }}"
    state: started
    restart_policy: "{{ restart_policy }}"
    command: bundle exec puma -C config/puma.rb
    networks:
      - name: "{{ proxy_network }}"
      - name: "{{ backend_network }}"
    env:
      LOCAL_DOMAIN: "{{ mastodon_domain }}"
      SECRET_KEY_BASE: "{{ mastodon_secret_key_base }}"
      OTP_SECRET: "{{ mastodon_otp_secret }}"
      VAPID_PRIVATE_KEY: "{{ mastodon_vapid_private_key }}"
      VAPID_PUBLIC_KEY: "{{ mastodon_vapid_public_key }}"
      DB_HOST: "{{ mastodon_db_host }}"
      DB_PORT: "{{ mastodon_db_port }}"
      DB_NAME: "{{ mastodon_db_name }}"
      DB_USER: "{{ mastodon_db_user }}"
      DB_PASS: "{{ mastodon_db_password }}"
      REDIS_HOST: "{{ mastodon_redis_host }}"
      REDIS_PORT: "{{ mastodon_redis_port }}"
      S3_ENABLED: "{{ mastodon_s3_enabled }}"
      S3_PROTOCOL: "{{ mastodon_s3_protocol }}"
      S3_BUCKET: "{{ mastodon_s3_bucket }}"
      S3_REGION: "{{ mastodon_s3_region }}"
      S3_HOSTNAME: "{{ mastodon_s3_hostname }}"
      S3_PERMISSION: "{{ mastodon_s3_permission }}"
      AWS_ACCESS_KEY_ID: "{{ mastodon_aws_access_key_id }}"
      AWS_SECRET_ACCESS_KEY: "{{ mastodon_aws_secret_access_key }}"
      SMTP_SERVER: "{{ mastodon_smtp_server }}"
      SMTP_PORT: "{{ mastodon_smtp_port }}"
      SMTP_LOGIN: "{{ mastodon_smtp_login }}"
      SMTP_PASSWORD: "{{ mastodon_smtp_password }}"
      SMTP_FROM_ADDRESS: "{{ mastodon_smtp_from_address }}"
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: "{{ mastodon_active_record_encryption_deterministic_key }}"
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: "{{ mastodon_active_record_encryption_key_derivation_salt }}"
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: "{{ mastodon_active_record_encryption_primary_key }}"
    volumes:
      - mastodon-system:/opt/mastodon/public/system
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/health || exit 1"]
      interval: "{{ healthcheck_interval }}"
      timeout: "{{ healthcheck_timeout }}"
      retries: "{{ healthcheck_retries }}"
      start_period: 60s
    labels:
      traefik.enable: "true"
      traefik.http.routers.mastodon.rule: "Host(`{{ mastodon_domain }}`)"
      traefik.http.routers.mastodon.entrypoints: "websecure"
      traefik.http.routers.mastodon.tls.certresolver: "letsencrypt"
      traefik.http.services.mastodon.loadbalancer.server.port: "{{ mastodon_web_port }}"
    log_driver: "{{ logging_driver }}"
    log_options:
      max-size: "{{ logging_max_size }}"
      max-file: "{{ logging_max_file }}"

- name: Deploy Mastodon Streaming
  community.docker.docker_container:
    name: mastodon-streaming
    image: "{{ mastodon_streaming_image }}"
    state: started
    restart_policy: "{{ restart_policy }}"
    networks:
      - name: "{{ proxy_network }}"
      - name: "{{ backend_network }}"
    env:
      LOCAL_DOMAIN: "{{ mastodon_domain }}"
      SECRET_KEY_BASE: "{{ mastodon_secret_key_base }}"
      OTP_SECRET: "{{ mastodon_otp_secret }}"
      VAPID_PRIVATE_KEY: "{{ mastodon_vapid_private_key }}"
      VAPID_PUBLIC_KEY: "{{ mastodon_vapid_public_key }}"
      DB_HOST: "{{ mastodon_db_host }}"
      DB_PORT: "{{ mastodon_db_port }}"
      DB_NAME: "{{ mastodon_db_name }}"
      DB_USER: "{{ mastodon_db_user }}"
      DB_PASS: "{{ mastodon_db_password }}"
      REDIS_HOST: "{{ mastodon_redis_host }}"
      REDIS_PORT: "{{ mastodon_redis_port }}"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4000/api/v1/streaming/health || exit 1"]
      interval: "{{ healthcheck_interval }}"
      timeout: "{{ healthcheck_timeout }}"
      retries: "{{ healthcheck_retries }}"
    labels:
      traefik.enable: "true"
      traefik.http.routers.mastodon-streaming.rule: "Host(`{{ mastodon_domain }}`) && PathPrefix(`/api/v1/streaming`)"
      traefik.http.routers.mastodon-streaming.entrypoints: "websecure"
      traefik.http.routers.mastodon-streaming.tls.certresolver: "letsencrypt"
      traefik.http.services.mastodon-streaming.loadbalancer.server.port: "{{ mastodon_streaming_port }}"
    log_driver: "{{ logging_driver }}"
    log_options:
      max-size: "{{ logging_max_size }}"
      max-file: "{{ logging_max_file }}"

- name: Deploy Mastodon Sidekiq
  community.docker.docker_container:
    name: mastodon-sidekiq
    image: "{{ mastodon_image }}"
    state: started
    restart_policy: "{{ restart_policy }}"
    command: bundle exec sidekiq
    networks:
      - name: "{{ proxy_network }}"
      - name: "{{ backend_network }}"
    env:
      LOCAL_DOMAIN: "{{ mastodon_domain }}"
      SECRET_KEY_BASE: "{{ mastodon_secret_key_base }}"
      OTP_SECRET: "{{ mastodon_otp_secret }}"
      VAPID_PRIVATE_KEY: "{{ mastodon_vapid_private_key }}"
      VAPID_PUBLIC_KEY: "{{ mastodon_vapid_public_key }}"
      DB_HOST: "{{ mastodon_db_host }}"
      DB_PORT: "{{ mastodon_db_port }}"
      DB_NAME: "{{ mastodon_db_name }}"
      DB_USER: "{{ mastodon_db_user }}"
      DB_PASS: "{{ mastodon_db_password }}"
      REDIS_HOST: "{{ mastodon_redis_host }}"
      REDIS_PORT: "{{ mastodon_redis_port }}"
      S3_ENABLED: "{{ mastodon_s3_enabled }}"
      S3_PROTOCOL: "{{ mastodon_s3_protocol }}"
      S3_BUCKET: "{{ mastodon_s3_bucket }}"
      S3_REGION: "{{ mastodon_s3_region }}"
      S3_HOSTNAME: "{{ mastodon_s3_hostname }}"
      S3_PERMISSION: "{{ mastodon_s3_permission }}"
      AWS_ACCESS_KEY_ID: "{{ mastodon_aws_access_key_id }}"
      AWS_SECRET_ACCESS_KEY: "{{ mastodon_aws_secret_access_key }}"
      SMTP_SERVER: "{{ mastodon_smtp_server }}"
      SMTP_PORT: "{{ mastodon_smtp_port }}"
      SMTP_LOGIN: "{{ mastodon_smtp_login }}"
      SMTP_PASSWORD: "{{ mastodon_smtp_password }}"
      SMTP_FROM_ADDRESS: "{{ mastodon_smtp_from_address }}"
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: "{{ mastodon_active_record_encryption_deterministic_key }}"
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: "{{ mastodon_active_record_encryption_key_derivation_salt }}"
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: "{{ mastodon_active_record_encryption_primary_key }}"
    volumes:
      - mastodon-system:/opt/mastodon/public/system
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep '[s]idekiq' || exit 1"]
      interval: "{{ healthcheck_interval }}"
      timeout: "{{ healthcheck_timeout }}"
      retries: "{{ healthcheck_retries }}"
    log_driver: "{{ logging_driver }}"
    log_options:
      max-size: "{{ logging_max_size }}"
      max-file: "{{ logging_max_file }}"
