# {{ ansible_managed }}
name: {{ stack_name }}

services:
  n8n:
    container_name: n8n
    image: {{ n8n_image }}
    restart: {{ restart_policy }}
    networks:
      - proxy
      - backend
    volumes:
      - n8n-data:/home/node/.n8n
    env_file:
      - ./env/n8n.env
    depends_on:
      n8n-db:
        condition: service_healthy
    labels:
      traefik.enable: "true"
      traefik.http.routers.n8n.rule: "Host(`{{ n8n_domain }}`)"
      traefik.http.routers.n8n.entrypoints: "websecure"
      traefik.http.routers.n8n.tls.certresolver: "letsencrypt"
      traefik.http.services.n8n.loadbalancer.server.port: "{{ n8n_port }}"
    logging:
      driver: {{ logging_driver }}
      options:
        max-size: {{ logging_max_size }}
        max-file: {{ logging_max_file }}

  n8n-db:
    container_name: n8n_postgres
    image: {{ n8n_db_image }}
    restart: {{ restart_policy }}
    networks:
      - backend
    volumes:
      - n8n-pgdata:/var/lib/postgresql/data
    env_file:
      - ./env/n8n-db.env
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "{{ n8n_db_user }}"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: {{ logging_driver }}
      options:
        max-size: "5m"
        max-file: {{ logging_max_file }}

  changedetection:
    container_name: changedetection
    image: {{ changedetection_image }}
    restart: {{ restart_policy }}
    networks:
      - proxy
    volumes:
      - ./config/changedetection:/datastore
    environment:
      - TZ={{ timezone }}
      - PORT={{ changedetection_port }}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:{{ changedetection_port }}"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: {{ logging_driver }}
      options:
        max-size: {{ logging_max_size }}
        max-file: {{ logging_max_file }}

  copyparty:
    container_name: copyparty
    image: {{ copyparty_image }}
    restart: {{ restart_policy }}
    user: "{{ puid }}:{{ pgid }}"
    networks:
      - proxy
    volumes:
      - ./config/copyparty:/cfg
      - videos:/w/Videos
      - music:/w/Music
      - downloads:/w/Downloads
      - photos:/w/Photos
      - comics:/w/Comics
      - games:/w/Games
    environment:
      - TZ={{ timezone }}
      - HOME=/cfg
      - XDG_CONFIG_HOME=/cfg
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:{{ copyparty_port }}"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: {{ logging_driver }}
      options:
        max-size: {{ logging_max_size }}
        max-file: {{ logging_max_file }}

volumes:
  n8n-data:
    external: true
  n8n-pgdata:
    external: true
  videos:
    external: true
  music:
    external: true
  downloads:
    external: true
  photos:
    external: true
  comics:
    external: true
  games:
    external: true

networks:
  proxy:
    name: {{ proxy_network }}
    external: true
  backend:
    name: {{ backend_network }}
    external: true
