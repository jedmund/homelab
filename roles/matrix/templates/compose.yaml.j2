# {{ ansible_managed }}
name: {{ stack_name }}

services:
  synapse:
    container_name: synapse
    build:
      context: .
      dockerfile: Dockerfile.synapse
    image: synapse-custom:latest
    restart: {{ restart_policy }}
    networks:
      - proxy
      - backend
    volumes:
      - synapse-data:/data
      - ./config/homeserver.yaml:/data/homeserver.yaml
      - ./config/synapse-signing.key:/config/signing.key:ro
    environment:
      - TZ={{ timezone }}
    env_file:
      - ./env/synapse.env
    depends_on:
      synapse-db:
        condition: service_healthy
    labels:
      traefik.enable: "true"
      traefik.http.routers.matrix.rule: "Host(`{{ synapse_domain }}`)"
      traefik.http.routers.matrix.entrypoints: "websecure"
      traefik.http.routers.matrix.tls.certresolver: "letsencrypt"
      traefik.http.routers.matrix.priority: "1"
      traefik.http.services.matrix.loadbalancer.server.port: "{{ synapse_port_http }}"
    healthcheck:
      test: ["CMD", "curl", "-fSs", "http://localhost:8008/health"]
      interval: {{ healthcheck_interval }}
      timeout: {{ healthcheck_timeout }}
      retries: {{ healthcheck_retries }}
      start_period: 60s
    logging:
      driver: {{ logging_driver }}
      options:
        max-size: {{ logging_max_size }}
        max-file: {{ logging_max_file }}

  synapse-db:
    container_name: synapse_postgres
    image: {{ synapse_db_image }}
    restart: {{ restart_policy }}
    networks:
      - backend
    volumes:
      - synapse-pgdata:/var/lib/postgresql/data
    env_file:
      - ./env/postgres.env
    environment:
      - POSTGRES_INITDB_ARGS=--encoding=UTF8 --lc-collate=C --lc-ctype=C
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "{{ synapse_db_user }}"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: {{ logging_driver }}
      options:
        max-size: "5m"
        max-file: {{ logging_max_file }}

  mas:
    container_name: mas
    image: {{ mas_image }}
    restart: {{ restart_policy }}
    command: server --config /data/config.yaml
    networks:
      - proxy
      - backend
    volumes:
      - ./config/mas-config.yaml:/data/config.yaml:ro
      - ./config/mas-signing.key:/keys/signing.key:ro
    depends_on:
      mas-db:
        condition: service_healthy
    labels:
      traefik.enable: "true"
      # MAS own domain (UI, OAuth, discovery)
      traefik.http.routers.mas.rule: "Host(`{{ mas_domain }}`)"
      traefik.http.routers.mas.entrypoints: "websecure"
      traefik.http.routers.mas.tls.certresolver: "letsencrypt"
      traefik.http.services.mas.loadbalancer.server.port: "{{ mas_port }}"
      # Compat routes: login/logout/refresh on Synapse domain go to MAS
      traefik.http.routers.mas-compat.rule: "Host(`{{ synapse_domain }}`) && PathRegexp(`^/_matrix/client/(r0|v3|unstable)/(login|logout|refresh)`)"
      traefik.http.routers.mas-compat.entrypoints: "websecure"
      traefik.http.routers.mas-compat.tls.certresolver: "letsencrypt"
      traefik.http.routers.mas-compat.priority: "100"
      traefik.http.routers.mas-compat.service: "mas"
    logging:
      driver: {{ logging_driver }}
      options:
        max-size: {{ logging_max_size }}
        max-file: {{ logging_max_file }}

  mas-db:
    container_name: mas_postgres
    image: {{ mas_db_image }}
    restart: {{ restart_policy }}
    networks:
      - backend
    volumes:
      - mas-pgdata:/var/lib/postgresql/data
    env_file:
      - ./env/mas-db.env
    environment:
      - POSTGRES_INITDB_ARGS=--encoding=UTF8 --lc-collate=C --lc-ctype=C
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "{{ mas_db_user }}"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: {{ logging_driver }}
      options:
        max-size: "5m"
        max-file: {{ logging_max_file }}

  element-web:
    container_name: element_web
    image: {{ element_image }}
    restart: {{ restart_policy }}
    networks:
      - proxy
    volumes:
      - ./config/element-config.json:/app/config.json:ro
    labels:
      traefik.enable: "true"
      traefik.http.routers.element.rule: "Host(`{{ element_domain }}`)"
      traefik.http.routers.element.entrypoints: "websecure"
      traefik.http.routers.element.tls.certresolver: "letsencrypt"
      traefik.http.services.element.loadbalancer.server.port: "{{ element_port }}"
      traefik.http.middlewares.element-headers.headers.customResponseHeaders.X-Frame-Options: "SAMEORIGIN"
      traefik.http.middlewares.element-headers.headers.customResponseHeaders.Cache-Control: "no-cache"
      traefik.http.routers.element.middlewares: "element-headers"
    logging:
      driver: {{ logging_driver }}
      options:
        max-size: {{ logging_max_size }}
        max-file: {{ logging_max_file }}

  synapse-admin:
    container_name: synapse_admin
    image: {{ synapse_admin_image }}
    restart: {{ restart_policy }}
    networks:
      - proxy
    labels:
      traefik.enable: "true"
      traefik.http.routers.synapse-admin.rule: "Host(`{{ synapse_admin_domain }}`)"
      traefik.http.routers.synapse-admin.entrypoints: "websecure"
      traefik.http.routers.synapse-admin.tls.certresolver: "letsencrypt"
      traefik.http.services.synapse-admin.loadbalancer.server.port: "{{ synapse_admin_port }}"
      traefik.http.routers.synapse-admin.middlewares: "tinyauth@file"
    logging:
      driver: {{ logging_driver }}
      options:
        max-size: {{ logging_max_size }}
        max-file: {{ logging_max_file }}

  livekit:
    container_name: livekit
    image: {{ livekit_image }}
    restart: {{ restart_policy }}
    command: --config /etc/livekit.yaml
    networks:
      - proxy
    ports:
      - "{{ livekit_rtc_tcp_port }}:7881"
      - "{{ livekit_rtc_port_start }}-{{ livekit_rtc_port_end }}:{{ livekit_rtc_port_start }}-{{ livekit_rtc_port_end }}/udp"
    volumes:
      - ./config/livekit.yaml:/etc/livekit.yaml:ro
    labels:
      traefik.enable: "true"
      traefik.http.routers.livekit.rule: "Host(`{{ livekit_domain }}`)"
      traefik.http.routers.livekit.entrypoints: "websecure"
      traefik.http.routers.livekit.tls.certresolver: "letsencrypt"
      traefik.http.services.livekit.loadbalancer.server.port: "7880"
    logging:
      driver: {{ logging_driver }}
      options:
        max-size: {{ logging_max_size }}
        max-file: {{ logging_max_file }}

  lk-jwt-service:
    container_name: lk_jwt_service
    image: {{ lk_jwt_service_image }}
    restart: {{ restart_policy }}
    networks:
      - proxy
    environment:
      - LIVEKIT_URL=wss://{{ livekit_domain }}
      - LIVEKIT_KEY={{ livekit_api_key }}
      - LIVEKIT_SECRET={{ livekit_api_secret }}
      - LIVEKIT_JWT_BIND=:8080
      - LIVEKIT_FULL_ACCESS_HOMESERVERS={{ synapse_server_name }}
    labels:
      traefik.enable: "true"
      traefik.http.routers.lk-jwt.rule: "Host(`{{ livekit_domain }}`) && PathPrefix(`/jwt`)"
      traefik.http.routers.lk-jwt.entrypoints: "websecure"
      traefik.http.routers.lk-jwt.tls.certresolver: "letsencrypt"
      traefik.http.services.lk-jwt.loadbalancer.server.port: "8080"
      traefik.http.middlewares.lk-jwt-strip.stripprefix.prefixes: "/jwt"
      traefik.http.routers.lk-jwt.middlewares: "lk-jwt-strip"
    logging:
      driver: {{ logging_driver }}
      options:
        max-size: {{ logging_max_size }}
        max-file: {{ logging_max_file }}

volumes:
  synapse-data:
  synapse-pgdata:
  mas-pgdata:

networks:
  proxy:
    name: {{ proxy_network }}
    external: true
  backend:
    name: {{ backend_network }}
    external: true
